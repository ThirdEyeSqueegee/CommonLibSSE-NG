name: Main CI

on:
  push:
    branches: main
    paths:
      - ".github/workflows/main_ci.yml"
      - "cmake/**"
      - "include/**"
      - "src/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - ".github/workflows/main_ci.yml"
      - "cmake/**"
      - "include/**"
      - "src/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
  workflow_dispatch:

env:
  VCPKG_COMMIT_ID: 68d349964cb4e8da561fd849d9491e6ba11c5681

jobs:
  test-build:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        build-type:
          - debug
          - release
        runtime:
          - all
          - flatrim
          - vr
        compiler:
          - msvc
          - clang-cl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get CMake
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}

      - name: Build
        uses: lukka/run-cmake@v10
        with:
          cmakeListsTxtPath: ${{ github.workspace }}/CMakeLists.txt
          configurePreset: build-${{ matrix.build-type }}-${{ matrix.compiler }}-vcpkg-${{ matrix.runtime }}
          buildPreset: ${{ matrix.build-type }}-${{ matrix.compiler }}-vcpkg-${{ matrix.runtime }}
